services:
    postgres:
        image: postgres:16-alpine
        container_name: notes-postgres
        restart: unless-stopped
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-notes_user}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
            POSTGRES_DB: ${POSTGRES_DB:-notes_db}
        volumes:
            - postgres_data:/var/lib/postgresql/data
            # Mount the migration that creates notify triggers
            - ../../src/db/migrations/0005_add_notify_triggers.sql:/docker-entrypoint-initdb.d/notify_triggers.sql:ro
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-notes_user} -d ${POSTGRES_DB:-notes_db}"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - notes-network

    app:
        build:
            context: ../..
            dockerfile: Dockerfile
        container_name: notes-app
        restart: unless-stopped
        environment:
            NODE_ENV: production
            DATABASE_URL: postgresql://${POSTGRES_USER:-notes_user}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-notes_db}
            BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:?BETTER_AUTH_SECRET is required}
            BETTER_AUTH_URL: ${BETTER_AUTH_URL:?BETTER_AUTH_URL is required}
            GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:?GITHUB_CLIENT_ID is required}
            GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:?GITHUB_CLIENT_SECRET is required}
            ALLOWED_GITHUB_USERNAME: ${ALLOWED_GITHUB_USERNAME:?ALLOWED_GITHUB_USERNAME is required}
        depends_on:
            postgres:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        networks:
            - notes-network

    nginx:
        image: nginx:alpine
        container_name: notes-nginx
        restart: unless-stopped
        ports:
            - "${HTTP_PORT:-80}:80"
            # Uncomment for HTTPS
            # - "${HTTPS_PORT:-443}:443"
        volumes:
            - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
            # Uncomment for SSL certificates
            # - ./ssl:/etc/nginx/ssl:ro
        depends_on:
            app:
                condition: service_healthy
        networks:
            - notes-network

networks:
    notes-network:
        driver: bridge

volumes:
    postgres_data:
